<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta http-equiv="Content-Style-Type" content="text/css" />
	<meta http-equiv="Content-Script-Type" content="text/javascript" />
	<meta http-equiv="imagetoolbar" content="no" />
	<meta name="description" content="" />
	<meta name="keywords" content="" />
	<link rel="stylesheet" href="../css/common.css" type="text/css" />
	<link type="text/css" rel="stylesheet" href="../css/styles/shCoreDefault.css"/>
	<script type="text/javascript" src="../css/scripts/shCore.js"></script>
	<script type="text/javascript" src="../css/scripts/shBrushBash.js"></script>
	<script type="text/javascript">SyntaxHighlighter.all();</script>
	<title>BLAS,LAPACKのビルドとチューニング〜</title>
	<!-- google analityics -->
	<script type="text/javascript">
	  var _gaq = _gaq || [];
	  _gaq.push(['_setAccount', 'UA-35918686-1']);
	  _gaq.push(['_trackPageview']);
	  (function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	  })();
	</script>
	<!-- google analityics end -->
</head>
<body>
<div id="top">
   <div id="contents">
		<h2>BLAS,LAPACKのビルドとチューニング(<a href="../dev_tips.html">全体の目次に戻る</a>)</h2>
ここでは、数値計算ライブラリのBLASとLAPACKのビルド法・チューニング法をまとめます。
今回は、ATLASと呼ばれるソフトウェアを用いて自動チューニングを実行します。
はじめに、BLAS,LAPACK,ATLASの大ざっぱな説明をまとめます。
<div class="border" style="background-color:#efefFF;" align="left">
<ul>
	<li>BLAS（Basic Linear Algebra Subprograms）は、行列同士の加算や乗算といった基本的な演算をつかさどるライブラリ群です。</li>
	<li>LAPACK（Linear Algebra Package）は、連立一次方程式や固有値分解のソルバーをパッキングしたライブラリ群です。</li>
</ul>
</div>
<div class="border" style="background-color:#efFFef;" align="left">
<ul>
	<li>ATLAS(Automatically Tuned Linear Algebra Software)は、自動的にコンピュータの性能を測定して、そのコンピュータに見合ったBLASを（LAPACKも）生成するソフトウェアです。</li>
</ul>
</div>
<hr/>
　BLASやLAPACKは有料のものもありますが、
ここでは、Netlibで無料公開されているものを用います。

<br/>
はじめに前処理を行いますが、以下のスクリプトはUbuntuで動作確認済みです。
他のOSをご利用の場合は適宜コマンドを置き換えて実行してください。
<pre class="brush: bash;">
# gcc, gfortran のインストール
sudo apt-get -y install gcc gfortran

# 最大のパフォーマンスが出せるように設定(しばらく待つ)
sudo cpufreq-selector -g performance
</pre>

では、チューニングのスクリプトを以下に示します。
ライブラリのインストールディレクトリは「/usr/local/lib/atlas」としています。

<pre class="brush: bash;">
#!/bin/bash

# ライブラリのインストールディレクトリ
INSTALL_DIR=/usr/local/lib/atlas

# ビルドディレクトリ
BUILD_DIR=~/_build_dir_

# LAPACKのバージョン
LPK_VER=3.5.0

# ATLASのバージョン(Stable版)
ATLAS_VER=3.10.1

# ATLAS と LAPACK のコンパイラオプションの設定
OPT_ATLAS="-fPIC -O3 -march=native -fopenmp -lgomp -lpthread -lgfortran"
OPT_LAPACK="${OPT_ATLAS}"

#############################################
# 1) LAPACK と ATLAS のダウンロード
#############################################

# 作業ディレクトリの作成
mkdir ${BUILD_DIR}

# LAPACK tar ファイルのダウンロード
cd "${BUILD_DIR}/"
if [ ! -f "lapack-${LPK_VER}.tgz" ]; then
  wget "http://www.netlib.org/lapack/lapack-${LPK_VER}.tgz"
fi

# ATLAS tar ファイルのダウンロードと展開
cd "${BUILD_DIR}/"
if [ ! -f "atlas${ATLAS_VER}.tar.bz2" ]; then
  wget "http://sourceforge.net/projects/math-atlas/files/Stable/${ATLAS_VER}/atlas${ATLAS_VER}.tar.bz2"
fi
rm -Rf "ATLAS/"
tar -jxvf "atlas${ATLAS_VER}.tar.bz2"

#############################################
# 2) ATLASを用いて最適化された BLAS と LAPACK を生成
#############################################

cd "${BUILD_DIR}/ATLAS/"
mkdir tmp
cd tmp/

# ビルドの設定
../configure -Si omp 1 -Fa al "${OPT_ATLAS}" --shared --prefix="${INSTALL_DIR}" --with-netlib-lapack-tarfile="${BUILD_DIR}/lapack-${LPK_VER}.tgz"

# ビルド開始（安静にして待つ）
make

# テスト（エラーがないか確認）
# make check   # perform sanity tests
# make ptcheck # checks of threaded code for multiprocessor systems
# make time    # provide performance summary as % of clock rate

# INSTALL_DIRにインストール
sudo make install

# *.a が保存されているディレクトリへ移動
cd "${BUILD_DIR}/ATLAS/tmp/lib/"

# 共有用の動的ライブラリ（.so）の抽出とインストール
for f in *.a; do
  rm -Rf tmp/
  mkdir tmp
  cd tmp/
  ar vx "../${f}"
  sudo gcc -shared -fPIC -o "${INSTALL_DIR}/lib/${f%%.a}_ATLAS.so" *.o
  cd ../
done
</pre>

<h3>ライブラリの使用方法</h3>
gccで使用するときのコンパイラオプション
<pre class="brush: bash;">
-Wl,-rpath="/usr/local/lib/atlas/lib" -L"/usr/local/lib/atlas/lib" -llapack_ATLAS -lcblas_ATLAS -lsatlas # シリアル版
-Wl,-rpath="/usr/local/lib/atlas/lib" -L"/usr/local/lib/atlas/lib" -lptlapack_ATLAS -lptcblas_ATLAS -ltatlas -fopenmp -lpthread # パラレル版
</pre>
gfortranで使用するときのコンパイラオプション
<pre class="brush: bash;">
-Wl,-rpath="/usr/local/lib/atlas/lib" -L"/usr/local/lib/atlas/lib" -llapack_ATLAS -lf77blas_ATLAS -lsatlas -gfortran # シリアル版
-Wl,-rpath="/usr/local/lib/atlas/lib" -L"/usr/local/lib/atlas/lib" -lptlapack_ATLAS -lptf77blas_ATLAS -ltatlas -fomp -lpthread -gfortran # パラレル版
</pre>
これらのオプションはBLASやLAPACKを使用するソフトウェアをソースコードからコンパイルするときに指定することができます。

   </div><!-- /#contents-->
   <div id="pageTop">
      <a href="#top">このページのトップへ戻る</a>
   </div><!-- /#pageTop-->
   <div id="footer">
            <div class="copyright">Copyright &copy; 2013 S.Suzumura Rights Reserved.</div>
   </div><!-- /#footer-->
</div><!-- /#top-->
</body>
</html>
